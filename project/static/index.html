<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>SPA SDK Sample</title>
  </head>

  <body>
    <!-- <script src="https://cdn.auth0.com/js/auth0-spa-js/1.13/auth0-spa-js.production.js"></script>
    <script src="js/app.js"></script>
    <script type="text/javascript">
      const login = async () => {
  await auth0.loginWithRedirect({
    redirect_uri: window.location.origin
  });
};
      import { handleAuth } from '@auth0/nextjs-auth0';
  
      export default handleAuth();
      //auth0.authorize();
    </script> -->
    <h2>SPA Authentication Sample</h2>
    <p>Welcome to our page!</p>
    <button id="btn-login" disabled="true" onclick="login()">Log in</button>
    <button id="btn-logout" disabled="true" onclick="logout()">Log out</button>
  </body>
  <script>


    // const user = localStorage.getItem('user');

		// 	if (!user) 
    //     {window.location.href = 'http://localhost:3000/home' }


    function GetQueryStringVal(lQuery)
    {

    var lDoc=String(document.location); 
    var lSignet = ""; 
    var n1 = lDoc.indexOf("?"); 

    if (n1 > 0) 
    { 
      var n2 = lDoc.indexOf("?" + lQuery + "=",n1); 
      if (n2 < n1) 
        n2 = lDoc.indexOf("&" + lQuery + "=",n1); 
      if (n2 >= n1) 
      { 
        n2 = n2 + ("?" + lQuery + "=").length; 
        var n3 = lDoc.indexOf("&",n2+1); 
        if (n3 > n2) 
          lSignet = lDoc.substring(n2, n3); 
        else 
          lSignet = lDoc.substring(n2); 
      } 
    }

    return lSignet;

    }
    const code = GetQueryStringVal('code');

    console.log('code = ', code);

    if (!code)
    {
      window.location.href = '';
    }

    options2 = {
      method: 'POST',
      mode: 'cors',
      credentials: 'include',
      headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json',
      'Access-Control-Max-Age': '600',
      'Cache-Control': 'no-cache'
      },
      body: JSON.stringify({
        code: code
      })
    };

    /* On effectue la requête */
    async function login()
    {
      const response = await fetch('http://localhost:3000/login', options2);
      const data = await response.json();
      localStorage.setItem('xsrfToken', JSON.stringify(data));
     // console.log('data = ', JSON.stringify(data));
    }

    login();


    Token = localStorage.getItem('xsrfToken');

    xsrfToken = JSON.parse(Token);
    console.log('tok = ', xsrfToken);

    const headers4 = new Headers();
    headers4.append('x-xsrf-token', xsrfToken);

    const options4 = {
      method: 'GET',
      mode: 'cors',
      headers4,
      credentials: 'include',
    };

    /* On effectue la requête */
    async function get_salut()
    {
      const response = await fetch('http://localhost:3000/salut', options4);
      // const data = await response.json();
      // console.log('data = ', data);
    }

  //  get_salut();


//     function getCookie(cname) {
//       let name = cname + "=";
//       let decodedCookie = decodeURIComponent(document.cookie);
//       let ca = decodedCookie.split(';');
//       for(let i = 0; i <ca.length; i++) {
//         let c = ca[i];
//         while (c.charAt(0) == ' ') {
//           c = c.substring(1);
//         }
//         if (c.indexOf(name) == 0) {
//           return c.substring(name.length, c.length);
//         }
//       }
//       return "";
//     }
  
//     function parseJwt (token) {
//     var base64Url = token.split('.')[1];
//     var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
//     var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
//         return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
//     }).join(''));

//     return JSON.parse(jsonPayload);
// };

//     token = getCookie('access_token');
//     if (!token)
//       window.location.href = 'http://localhost:3000/login';
//   console.log(token);

//   let xsrfToken = parseJwt(token).xsrfToken;

//   console.log('\nxsrfToken = ', xsrfToken);

//   localStorage.setItem('xsrfToken', JSON.stringify(xsrfToken));


// xsrfToken = localStorage.getItem('xsrfToken');
// if (!xsrfToken) {
//   /* Traitement dans le cas où le token CSRF n'existe dans le localStorage */
// }
// /* Le localStorage stocke les données sous forme de chaines de caractères nous transformons donc la donnée en JSON */
// xsrfToken = JSON.parse(xsrfToken);

// /* On créer l'en-tête x-xsrf-token contenant le token CSRF */
// const headers = new Headers();
// headers.append('x-xsrf-token', xsrfToken);

// const options = {
//   method: 'GET',
//   mode: 'cors',
//   headers,
//   credentials: 'include'
// };

// /* On effectue la requête */
// async function get_salut()
// {
//   const response = await fetch('http://localhost:3000/salut', options);
//   const data = await response.json();
//   console.log(data);
// }

// get_salut();



//     const response = fetch('http://127.0.0.1:3000/login', {
//   mode: 'cors',
//   headers: {
//     'Access-Control-Allow-Origin':'*'
//   }
// });
// const text = response.text();
// console.log('text = ', text)


// let promise = fetch("http://127.0.0.1:3000/salut", {
//     method: "GET", //ou POST, PUT, DELETE, etc.
//     headers: {
//       "Content-Type": "text/plain;charset=UTF-8" //pour un corps de type chaine
//     },
//     // body: undefined, //ou string, FormData, Blob, BufferSource, ou URLSearchParams
//     // referrer: "about:client", //ou "" (pas de réferanr) ou une url de l'origine
//     // referrerPolicy: "origin", //ou no-referrer, origin, same-origin...
//     mode: "cors", //ou same-origin, no-cors
//     //credentials: "include", //ou omit, include
//     // cache: "default", //ou no-store, reload, no-cache, force-cache, ou only-if-cached
//     // redirect: "follow", //ou manual ou error
//     // integrity: "", //ou un hash comme "sha256-abcdef1234567890"
//     // keepalive: false, //ou true pour que la requête survive à la page
//     // signal: undefined, //ou AbortController pour annuler la requête
//       headers: {
//     'Access-Control-Allow-Origin':'*'
//   }
    
// });

//   async function get_api() {
//   const response = await fetch("http://127.0.0.1:3000/login")//, {
//   // mode: "cors",
//   // headers: {
//   //   "Access-Control-Allow-Origin":"*"
//   // }});



//   // response.ok;     // => false
//   // response.status; // => 404
//   const text = await response.text();
//   console.log('text = ', text);
//   // const data = await response.json();
//   // console.log('data = ', data);
//   //return text;
// }
// console.log(get_api());

//    function sleep(seconds){
//     var waitUntil = new Date().getTime() + seconds*1000;
//     while(new Date().getTime() < waitUntil) 
//         true;
//   }
//  // sleep(10); 
//     console.log("after sleep");    
//client.setRequestHeader('Access-Control-Allow-Origin', 'http://127.0.0.1:3000');
//window.Headers('cookies')
    // var client = new XMLHttpRequest();
    // client.open('Get' ,'http://127.0.0.1:3000/register');
    // client.send();
    // client.onload = function() {
    //   if (client.status != 200) { // analyze HTTP status of the response
    //     alert(`Error ${client.status}: ${client.statusText}`); // e.g. 404: Not Found
    //   } else { // show the result
    //     alert(client.response); // response is the server response
    //   }
    // };
    // if (!client.response)
    // {
    //   window.location.href = 'http://localhost:3000/home'
    // }
    
// client.onprogress = function(event) {
//   if (event.lengthComputable) {
//     alert(`Received ${event.loaded} of ${event.total} bytes`);
//   } else {
//     alert(`Received ${event.loaded} bytes`); // no Content-Length
//   }
  
// };

// client.onerror = function() {
//   alert("Request failed");
// };
// console.log('response = ', client.response);
// console.log("past");
/* On récupère le token CSRF depuis le localStorage */
//const cook = document.Cookie;
//var cookies = document.cookie.split('assess-token');
//console.log('document.location : ', document);
// if (!cook)
//   window.location.href = 'http://localhost:3000/login'
// var req = new XMLHttpRequest();
// req.open('GET', document.location, false);
// req.send(null);
// var headers = req.getAllResponseHeaders().toLowerCase();
// alert(headers);
// let xsrfToken = localStorage.getItem('xsrfToken');
// if (!xsrfToken) {
//   /* Traitement dans le cas où le token CSRF n'existe dans le localStorage */
//   console.log('xsrfToken absent');
// }
// console.log('xsrfToken = ', xsrfToken);
// /* Le localStorage stocke les données sous forme de chaines de caractères nous transformons donc la donnée en JSON */
// xsrfToken = JSON.parse(xsrfToken);
 
// /* On créer l'en-tête x-xsrf-token contenant le token CSRF */
// headers = new Headers();
// headers.append('x-xsrf-token', xsrfToken);
// //     var client = new XMLHttpRequest();
//     client.open('Get' ,'http://localhost:3000/salut'); 
//     client.send({token: 'coucou'});
//     client.onload = function() {
//       if (client.status != 200) { // analyze HTTP status of the response
//         alert(`Error ${client.status}: ${client.statusText}`); // e.g. 404: Not Found
//       } else { // show the result
//         alert(client.response); // response is the server response
//       }
//     };
    
// client.onprogress = function(event) {
//   if (event.lengthComputable) {
//     alert(`Received ${event.loaded} of ${event.total} bytes`);
//   } else {
//     alert(`Received ${event.loaded} bytes`); // no Content-Length
//   }

// };

// client.onerror = function() {
//   alert("Request failed");
// };


//console.log(data);
   


// </html>


// <!-- <!DOCTYPE html>
  // <html>
  // <body>
    
    // <h1>My First Heading</h1>
    // <script src="socket.io/socket.io.js"></script>
    // <script>
      //     // Create SocketIO instance, connect
      
      //     var socket = new io();
      
      //     socket.connect('http://127.0.0.1:3000'); 
      
      //     // // Add a connect listener
      //     socket.on('connect', function() {
        //       console.log('Client has connected to the server!');
        //     });
        //     // Add a connect listener
        //     socket.on('message',function(data) {
          //       console.log('Received a message from the server!',data);
          //     });
          //     // Add a disconnect listener
          //     socket.on('disconnect',function() {
            //       console.log('The client has disconnected!');
            //     });
            //     socket.emit('add user', { "nom": "jerome" });
            //     // Sends a message to the server via sockets
            //     // function sendMessageToServer(message) {
              //     //   socket.send(message);
              //     // };
              // </script>
              // <p>My first paragraph.</p>
              // </body>
              // </html>
 </script>